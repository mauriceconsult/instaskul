generator client {
  provider = "prisma-client-js"
  output   = "../node_modules/.prisma/client"
}

datasource db {
  provider = "postgresql"
}

model School {
  id      String    @id @default(uuid())
  name    String    @unique
  admins  Admin[] 
}

model Tuition {
  id             String       @id @default(uuid())
  userId         String
  partyId        String?
  username       String?
  courseId       String?
  course         Course?      @relation(fields: [courseId], references: [id], onDelete: Cascade)
  amount         String?
  isActive       Boolean      @default(true)
  isPaid         Boolean      @default(false)
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  status         String?
  transId        String?
  transactionId  String?
  enrolleeUserId String?
  attachments    Attachment[]
  enrollment     Enrollment?  @relation("TuitionToEnrollment")
  payrolls        Payroll[]    @relation("TuitionToPayroll")
  
  @@unique([userId, courseId])
  @@index([courseId])
}
model Payroll {
  id               String   @id @default(uuid()) 
  tuitionId        String   @unique
  userId           String
  courseId         String
  adminId          String
  
  grossAmount      String   
  platformFee      String   
  transactionFee   String   
  netPayout        String
 
  momoReferenceId  String?  @unique
  momoStatus       String   @default("PENDING") 

  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  paidAt           DateTime?
 
  tuition          Tuition  @relation("TuitionToPayroll", fields: [tuitionId], references: [id], onDelete: Cascade)
  course           Course   @relation(fields: [courseId], references: [id], onDelete: Cascade) 
  
  @@index([adminId, momoStatus])
  @@index([tuitionId])
  @@index([courseId])
  @@index([adminId])
  @@index([momoStatus])
  @@index([paidAt])
  @@index([createdAt])
}

model Content {
  id          String   @id @default(uuid())
  courseId    String
  userId      String
  isCompleted Boolean  @default(false)
  title       String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  course      Course   @relation(fields: [courseId], references: [id])
}

model CourseNoticeboard {
  id          String       @id @default(uuid())
  userId      String
  title       String
  courseId    String?
  description String?
  position    Int?
  isPublished Boolean      @default(false)
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  courseNoticeboardComments CourseNoticeboardComment[]
  attachments Attachment[]
  
  course      Course?      @relation(fields: [courseId], references: [id], onDelete: Cascade)

  @@index([courseId])
}

model Coursework {
  id           String         @id @default(uuid())
  title        String
  userId       String
  description  String?
  position     Int?
  isPublished  Boolean        @default(false)
  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt
  courseId     String?
  publishDate  DateTime?
  attachments  Attachment[]
  course       Course?        @relation(fields: [courseId], references: [id], onDelete: Cascade)
  courseworkSubmissions CourseworkSubmission[]
  userProgress UserProgress[]

  @@index([courseId])
}

model Admin {
  id           String        @id @default(uuid())
  userId       String
  title        String
  description  String?
  position     Int?
  isPublished  Boolean       @default(false)
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  imageUrl     String?
  schoolId     String?
  school       School?       @relation(fields: [schoolId], references: [id])
  attachments  Attachment[]
  courses      Course[]
  noticeboards Noticeboard[]
  userProgress       UserProgress[]  

  @@index([schoolId])
}

model Course {
  id                 String              @id @default(uuid())
  title              String
  userId             String?
  description        String?
  imageUrl           String?
  amount             String              @default("0") // ‚Üê No longer nullable, default to 0
  position           Int?
  isPublished        Boolean             @default(false)
  createdAt          DateTime            @default(now())
  updatedAt          DateTime            @updatedAt
  publishDate        DateTime?
  adminId            String?
  attachments        Attachment[]
  contents           Content[]
  admin              Admin?              @relation(fields: [adminId], references: [id], onDelete: Cascade)
  courseNoticeboards CourseNoticeboard[]
  courseworks        Coursework[]
  enrollments        Enrollment[]
  tuitions           Tuition[]
  tutors             Tutor[]
  userProgress       UserProgress[]
  payrolls           Payroll[]

  @@index([adminId])
}

model Enrollment {
  id        String   @id @default(uuid())
  userId    String
  courseId  String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  tuitionId String   @unique
  course    Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)
  tuition   Tuition  @relation("TuitionToEnrollment", fields: [tuitionId], references: [id], onDelete: Cascade)

  @@unique([userId, courseId])
  @@index([userId])
  @@index([courseId])
}

model Tutor {
  id           String         @id @default(uuid())
  userId       String?
  title        String
  description  String?        @db.Text
  objective    String?        @db.Text
  videoUrl     String?
  position     Int            @default(0)
  isPublished  Boolean        @default(false)
  isFree       Boolean        @default(false)
  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt
  courseId     String?
  adminId      String?
  isCompleted  Boolean        @default(false)
  
  // Mux foreign key
  muxDataId    String?        @unique

  // Relations
  assignments  Assignment[]
  attachments  Attachment[]
  course       Course?        @relation(fields: [courseId], references: [id], onDelete: Cascade)
  muxData      MuxData?       
  userProgress UserProgress[]

  @@index([courseId])
}

model MuxData {
  id         String   @id @default(uuid())
  assetId    String
  playbackId String?

  tutorId    String   @unique
  tutor      Tutor    @relation(fields: [tutorId], references: [id], onDelete: Cascade)

  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
}

model Assignment {
  id           String         @id @default(uuid())
  userId       String?
  title        String
  description  String?
  position     Int?
  isPublished  Boolean        @default(false)
  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt
  tutorId      String?
  publishDate  DateTime?
  tutor        Tutor?         @relation(fields: [tutorId], references: [id], onDelete: Cascade)
  assignmentSubmissions AssignmentSubmission[]
  attachments  Attachment[]
  userProgress UserProgress[]

  @@index([tutorId])
}

model Attachment {
  id                  String             @id @default(uuid())
  url                 String
  courseId            String?
  createdAt           DateTime           @default(now())
  updatedAt           DateTime           @updatedAt
  noticeboardId       String?
  courseworkId        String?
  assignmentId        String?
  courseNoticeboardId String?
  tutorId             String?
  tuitionId           String?
  payrollId           String?
  adminId             String?
  adminPayrollId      String?
  admin               Admin?             @relation(fields: [adminId], references: [id], onDelete: Cascade)
  assignment          Assignment?        @relation(fields: [assignmentId], references: [id], onDelete: Cascade)
  course              Course?            @relation(fields: [courseId], references: [id], onDelete: Cascade)
  courseNoticeboard   CourseNoticeboard? @relation(fields: [courseNoticeboardId], references: [id], onDelete: Cascade)
  coursework          Coursework?        @relation(fields: [courseworkId], references: [id], onDelete: Cascade)
  noticeboard         Noticeboard?       @relation(fields: [noticeboardId], references: [id], onDelete: Cascade)
  tuition             Tuition?           @relation(fields: [tuitionId], references: [id], onDelete: Cascade)
  tutor               Tutor?             @relation(fields: [tutorId], references: [id], onDelete: Cascade)

  @@index([adminId, courseId, courseworkId, noticeboardId, courseNoticeboardId, payrollId, tuitionId, tutorId])
}

model UserProgress {
  id           String      @id @default(uuid())
  userId       String
  tutorId      String?
  assignmentId String?
  courseworkId String?
  isCompleted  Boolean     @default(false)
  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt
  courseId     String?
  courses      Course?     @relation(fields: [courseId], references: [id], onDelete: Cascade)
  adminId     String?
  admins      Admin?     @relation(fields: [adminId], references: [id], onDelete: Cascade)
  isEnrolled   Boolean     @default(false)
  assignments  Assignment? @relation(fields: [assignmentId], references: [id], onDelete: Cascade)
  courseworks  Coursework? @relation(fields: [courseworkId], references: [id], onDelete: Cascade)
  tutors       Tutor?      @relation(fields: [tutorId], references: [id], onDelete: Cascade)

  @@unique([userId, tutorId])
  @@unique([userId, courseworkId])
  @@unique([userId, courseId])
  @@unique([userId, assignmentId])
  @@index([userId, adminId])
  @@index([adminId, courseId, courseworkId, tutorId, assignmentId])
}

model Noticeboard {
  id          String       @id @default(uuid())
  title       String
  userId      String
  description String?
  position    Int?
  isPublished Boolean      @default(false)
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  publishDate DateTime?
  adminId     String?
  attachments Attachment[]
  noticeboardComments NoticeboardComment[]
  admin       Admin?       @relation(fields: [adminId], references: [id], onDelete: Cascade)

  @@index([adminId])
}

model NoticeboardComment {
  id             String    @id @default(cuid())
  noticeboardId  String
  userId         String
  content        String
  createdAt      DateTime  @default(now())
  adminId       String?   // for replies

  noticeboard    Noticeboard @relation(fields: [noticeboardId], references: [id])  
  admin         NoticeboardComment? @relation("CommentReplies", fields: [adminId], references: [id])
  replies        NoticeboardComment[] @relation("CommentReplies")

  @@index([noticeboardId])
  @@index([userId])
  @@index([adminId])
}

model CourseNoticeboardComment {
  id                    String    @id @default(cuid())
  courseNoticeboardId   String
  userId                String
  content               String
  createdAt             DateTime  @default(now())
  courseId              String?
  courseNoticeboard     CourseNoticeboard @relation(fields: [courseNoticeboardId], references: [id])
  course                CourseNoticeboardComment? @relation("CourseCommentReplies", fields: [courseId], references: [id])
  replies               CourseNoticeboardComment[] @relation("CourseCommentReplies")

  @@index([courseNoticeboardId])
  @@index([userId])
  @@index([courseId])
}
model AssignmentSubmission {
  id           String    @id @default(cuid())
  assignmentId String
  userId       String
  fileUrl      String?
  text         String?
  submittedAt  DateTime  @default(now())
  isGraded     Boolean   @default(false)
  grade        Float?
  feedback     String?
  assignment   Assignment @relation(fields: [assignmentId], references: [id], onDelete: Cascade)

  @@index([assignmentId])
  @@index([userId])
  @@unique([assignmentId, userId])
}

model CourseworkSubmission {
  id           String    @id @default(cuid())
  courseworkId String
  userId       String
  fileUrl      String?
  text         String?
  submittedAt  DateTime  @default(now())
  isGraded     Boolean   @default(false)
  grade        Float?
  feedback     String?

  coursework   Coursework @relation(fields: [courseworkId], references: [id], onDelete: Cascade)
  

  @@index([courseworkId])
  @@index([userId])
  @@unique([courseworkId, userId])
}
